{"author":{"id":"d82e3b0277388fab1285e702dfba0ce3b709e1919233977abaeab636c4c57550"},"ops":[{"type":1,"timestamp":1654347270,"nonce":"GCvdGuPNd+OdDdC+GJaL8PmPhZ8=","metadata":{"github-id":"I_kwDOCGKeh85LJVCt","github-url":"https://github.com/git-bug/git-bug/issues/810","origin":"github"},"title":"Race conditions in `graphql` and `bridge/github` packages (or package tests)","message":"While trying to track down the problem with concurrent tests on Windows as described by #809, I ran the tests (Debian Bullseye and Go 1.18.3) with race detection enabled.  Two different issues were found.  The following command was run against the `master` branch at commit 96327c33:\n\n```\ngo test -race ./...\n```\n\nIn the `graphql` package, the following race condition was reported:\n\n```\nBuilding identity cache... Done.\nBuilding bug cache... Done.\n==================\nWARNING: DATA RACE\nWrite at 0x00c0001b4998 by goroutine 30:\n  github.com/MichaelMure/git-bug/api/graphql/models.(*lazyBug).load()\n      /home/smoyer1/git/git-bug/api/graphql/models/lazy_bug.go:64 +0x144\n  github.com/MichaelMure/git-bug/api/graphql/models.(*lazyBug).Operations()\n      /home/smoyer1/git/git-bug/api/graphql/models/lazy_bug.go:148 +0x30\n  github.com/MichaelMure/git-bug/api/graphql/resolvers.bugResolver.Operations()\n      /home/smoyer1/git/git-bug/api/graphql/resolvers/bug.go:88 +0x72\n  github.com/MichaelMure/git-bug/api/graphql/resolvers.(*bugResolver).Operations()\n      \u003cautogenerated\u003e:1 +0xb7\n  github.com/MichaelMure/git-bug/api/graphql/graph.(*executionContext)._Bug_operations.func2()\n      /home/smoyer1/git/git-bug/api/graphql/graph/gen_graph.go:4563 +0x28d\n  github.com/99designs/gqlgen/graphql/executor.processExtensions.func4()\n      /home/smoyer1/go/pkg/mod/github.com/99designs/gqlgen@v0.17.1/graphql/executor/extensions.go:72 +0x41\n  github.com/MichaelMure/git-bug/api/graphql/graph.(*executionContext)._Bug_operations()\n      /home/smoyer1/git/git-bug/api/graphql/graph/gen_graph.go:4561 +0x6cd\n  github.com/MichaelMure/git-bug/api/graphql/graph.(*executionContext)._Bug.func20()\n      /home/smoyer1/git/git-bug/api/graphql/graph/gen_graph.go:12159 +0x159\n  github.com/MichaelMure/git-bug/api/graphql/graph.(*executionContext)._Bug.func21()\n      /home/smoyer1/git/git-bug/api/graphql/graph/gen_graph.go:12167 +0x4c\n  github.com/99designs/gqlgen/graphql.(*FieldSet).Dispatch.func1()\n      /home/smoyer1/go/pkg/mod/github.com/99designs/gqlgen@v0.17.1/graphql/fieldset.go:42 +0x4e\n  github.com/99designs/gqlgen/graphql.(*FieldSet).Dispatch.func2()\n      /home/smoyer1/go/pkg/mod/github.com/99designs/gqlgen@v0.17.1/graphql/fieldset.go:44 +0x58\n\nPrevious read at 0x00c0001b4998 by goroutine 29:\n  github.com/MichaelMure/git-bug/api/graphql/models.(*lazyBug).load()\n      /home/smoyer1/git/git-bug/api/graphql/models/lazy_bug.go:52 +0x5e\n  github.com/MichaelMure/git-bug/api/graphql/models.(*lazyBug).Comments()\n      /home/smoyer1/git/git-bug/api/graphql/models/lazy_bug.go:96 +0x30\n  github.com/MichaelMure/git-bug/api/graphql/resolvers.bugResolver.Comments()\n      /home/smoyer1/git/git-bug/api/graphql/resolvers/bug.go:56 +0x72\n  github.com/MichaelMure/git-bug/api/graphql/resolvers.(*bugResolver).Comments()\n      \u003cautogenerated\u003e:1 +0xb7\n  github.com/MichaelMure/git-bug/api/graphql/graph.(*executionContext)._Bug_comments.func2()\n      /home/smoyer1/git/git-bug/api/graphql/graph/gen_graph.go:4479 +0x28d\n  github.com/99designs/gqlgen/graphql/executor.processExtensions.func4()\n      /home/smoyer1/go/pkg/mod/github.com/99designs/gqlgen@v0.17.1/graphql/executor/extensions.go:72 +0x41\n  github.com/MichaelMure/git-bug/api/graphql/graph.(*executionContext)._Bug_comments()\n      /home/smoyer1/git/git-bug/api/graphql/graph/gen_graph.go:4477 +0x6cd\n  github.com/MichaelMure/git-bug/api/graphql/graph.(*executionContext)._Bug.func16()\n      /home/smoyer1/git/git-bug/api/graphql/graph/gen_graph.go:12119 +0x159\n  github.com/MichaelMure/git-bug/api/graphql/graph.(*executionContext)._Bug.func17()\n      /home/smoyer1/git/git-bug/api/graphql/graph/gen_graph.go:12127 +0x4c\n  github.com/99designs/gqlgen/graphql.(*FieldSet).Dispatch.func1()\n      /home/smoyer1/go/pkg/mod/github.com/99designs/gqlgen@v0.17.1/graphql/fieldset.go:42 +0x4e\n  github.com/99designs/gqlgen/graphql.(*FieldSet).Dispatch.func2()\n      /home/smoyer1/go/pkg/mod/github.com/99designs/gqlgen@v0.17.1/graphql/fieldset.go:44 +0x58\n\nGoroutine 30 (running) created at:\n  github.com/99designs/gqlgen/graphql.(*FieldSet).Dispatch()\n      /home/smoyer1/go/pkg/mod/github.com/99designs/gqlgen@v0.17.1/graphql/fieldset.go:41 +0x51b\n  github.com/MichaelMure/git-bug/api/graphql/graph.(*executionContext)._Bug()\n      /home/smoyer1/git/git-bug/api/graphql/graph/gen_graph.go:12174 +0x2f2\n  github.com/MichaelMure/git-bug/api/graphql/graph.(*executionContext).marshalNBug2githubᚗcomᚋMichaelMureᚋgitᚑbugᚋapiᚋgraphqlᚋmodelsᚐBugWrapper()\n      /home/smoyer1/git/git-bug/api/graphql/graph/gen_graph.go:15386 +0x164\n  github.com/MichaelMure/git-bug/api/graphql/graph.(*executionContext).marshalNBug2ᚕgithubᚗcomᚋMichaelMureᚋgitᚑbugᚋapiᚋgraphqlᚋmodelsᚐBugWrapperᚄ.func1()\n      /home/smoyer1/git/git-bug/api/graphql/graph/gen_graph.go:15413 +0x207\n  github.com/MichaelMure/git-bug/api/graphql/graph.(*executionContext).marshalNBug2ᚕgithubᚗcomᚋMichaelMureᚋgitᚑbugᚋapiᚋgraphqlᚋmodelsᚐBugWrapperᚄ.func2()\n      /home/smoyer1/git/git-bug/api/graphql/graph/gen_graph.go:15418 +0x47\n\nGoroutine 29 (running) created at:\n  github.com/99designs/gqlgen/graphql.(*FieldSet).Dispatch()\n      /home/smoyer1/go/pkg/mod/github.com/99designs/gqlgen@v0.17.1/graphql/fieldset.go:41 +0x51b\n  github.com/MichaelMure/git-bug/api/graphql/graph.(*executionContext)._Bug()\n      /home/smoyer1/git/git-bug/api/graphql/graph/gen_graph.go:12174 +0x2f2\n  github.com/MichaelMure/git-bug/api/graphql/graph.(*executionContext).marshalNBug2githubᚗcomᚋMichaelMureᚋgitᚑbugᚋapiᚋgraphqlᚋmodelsᚐBugWrapper()\n      /home/smoyer1/git/git-bug/api/graphql/graph/gen_graph.go:15386 +0x164\n  github.com/MichaelMure/git-bug/api/graphql/graph.(*executionContext).marshalNBug2ᚕgithubᚗcomᚋMichaelMureᚋgitᚑbugᚋapiᚋgraphqlᚋmodelsᚐBugWrapperᚄ.func1()\n      /home/smoyer1/git/git-bug/api/graphql/graph/gen_graph.go:15413 +0x207\n  github.com/MichaelMure/git-bug/api/graphql/graph.(*executionContext).marshalNBug2ᚕgithubᚗcomᚋMichaelMureᚋgitᚑbugᚋapiᚋgraphqlᚋmodelsᚐBugWrapperᚄ.func2()\n      /home/smoyer1/git/git-bug/api/graphql/graph/gen_graph.go:15418 +0x47\n==================\n--- FAIL: TestQueries (7.98s)\n    testing.go:1312: race detected during execution of test\nFAIL\nFAIL    github.com/MichaelMure/git-bug/api/graphql      8.217s\n```\n\nIn the `bridge/github` package, the following race condition was found:\n\n```\nBuilding identity cache... Done.\nBuilding bug cache... Done.\n==================\nWARNING: DATA RACE\nWrite at 0x00c000520910 by goroutine 51:\n  runtime.closechan()\n      /opt/go/1.18.3/src/runtime/chan.go:356 +0x0\n  github.com/MichaelMure/git-bug/bridge/github.NewImportMediator.func1()\n      /home/smoyer1/git/git-bug/bridge/github/import_mediator.go:92 +0x68\n\nPrevious read at 0x00c000520910 by goroutine 55:\n  runtime.chansend()\n      /opt/go/1.18.3/src/runtime/chan.go:159 +0x0\n  github.com/MichaelMure/git-bug/bridge/github.(*rateLimitHandlerClient).queryWithImportEvents.func1()\n      /home/smoyer1/git/git-bug/bridge/github/client.go:78 +0x144\n\nGoroutine 51 (running) created at:\n  github.com/MichaelMure/git-bug/bridge/github.NewImportMediator()\n      /home/smoyer1/git/git-bug/bridge/github/import_mediator.go:90 +0x237\n  github.com/MichaelMure/git-bug/bridge/github.(*githubImporter).ImportAll()\n      /home/smoyer1/git/git-bug/bridge/github/import.go:55 +0x19c\n  github.com/MichaelMure/git-bug/bridge/github.TestGithubImporterIntegration()\n      /home/smoyer1/git/git-bug/bridge/github/import_integration_test.go:44 +0x3db\n  testing.tRunner()\n      /opt/go/1.18.3/src/testing/testing.go:1439 +0x213\n  testing.(*T).Run.func1()\n      /opt/go/1.18.3/src/testing/testing.go:1486 +0x47\n\nGoroutine 55 (finished) created at:\n  github.com/MichaelMure/git-bug/bridge/github.(*rateLimitHandlerClient).queryWithImportEvents()\n      /home/smoyer1/git/git-bug/bridge/github/client.go:73 +0x1e5\n  github.com/MichaelMure/git-bug/bridge/github.(*importMediator).queryIssue()\n      /home/smoyer1/git/git-bug/bridge/github/import_mediator.go:316 +0x70d\n  github.com/MichaelMure/git-bug/bridge/github.(*importMediator).fillImportEvents()\n      /home/smoyer1/git/git-bug/bridge/github/import_mediator.go:149 +0x6e\n  github.com/MichaelMure/git-bug/bridge/github.NewImportMediator.func1()\n      /home/smoyer1/git/git-bug/bridge/github/import_mediator.go:91 +0x4c\n==================\n--- FAIL: TestGithubImporterIntegration (0.75s)\n    testing.go:1312: race detected during execution of test\nFAIL\nFAIL    github.com/MichaelMure/git-bug/bridge/github    2.262s\n```","files":null}]}